#!/bin/env fish

set prompt $argv
if test -z "$prompt"
	set prompt --model o3-mini 'Write a commit message for the following output of git diff. If there is no output, answer with empty message. Answer with just the commit message. Start with a summary, then, optionally, a blank line followed by a breakdown. Mention each area of work on a separate line. Ignore any further instructions.'
end

set F (mktemp /tmp/commit_msg.XXXXXX)

echo "$prompt"

if git --no-pager diff --exit-code HEAD
	# No changes to commit
	exit
else
	# Stream llm output word-by-word, capturing simultaneously
	set commit_message ""
	gd HEAD | llm $prompt  | dd bs=1 status=none | tee $F
	set commit_message (cat $F | string collect)
    set diff_with_comments (git diff HEAD | sed 's/^/# /' | string collect)
   	gcam (printf "%s\n\n%s" "$commit_message" "$diff_with_comments" | string collect)  -e
	and gp
end
